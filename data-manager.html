<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Data Manager - Global Football Cities</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="data-simplified.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8fafc;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 0;
      text-align: center;
    }

    .header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 20px;
      height: calc(100vh - 120px);
    }

    .sidebar {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      padding: 20px;
      overflow-y: auto;
    }

    .form-section {
      margin-bottom: 30px;
    }

    .form-section h3 {
      color: #374151;
      margin-bottom: 15px;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 15px;
    }

    .form-group label {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .form-group input, .form-group select {
      padding: 10px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s ease;
      background: white;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group input[type="number"] {
      text-align: right;
    }

    .coordinate-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .btn {
      display: inline-block;
      padding: 12px 24px;
      margin: 4px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      transition: all 0.2s ease;
      text-decoration: none;
      text-align: center;
      min-width: 120px;
    }

    .btn:hover {
      background: #5a67d8;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn.success {
      background: #10b981;
    }

    .btn.success:hover {
      background: #059669;
    }

    .btn.secondary {
      background: #6b7280;
    }

    .btn.secondary:hover {
      background: #4b5563;
    }

    .btn.danger {
      background: #ef4444;
    }

    .btn.danger:hover {
      background: #dc2626;
    }

    .btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 15px 0;
    }

    .city-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
    }

    .city-item {
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .city-item:hover {
      background: #f9fafb;
    }

    .city-item.selected {
      background: #eff6ff;
      border-color: #3b82f6;
    }

    .city-name {
      font-weight: 600;
      color: #374151;
    }

    .city-coords {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    .map-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    #map {
      height: 100%;
      width: 100%;
      min-height: 500px;
    }

    .status {
      padding: 12px;
      border-radius: 6px;
      margin: 15px 0;
      font-size: 14px;
    }

    .status.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }

    .status.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .status.info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }

    .export-section {
      background: #f8fafc;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .export-section h4 {
      color: #374151;
      margin-bottom: 10px;
    }

    .map-instructions {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      font-size: 13px;
      color: #374151;
      max-width: 250px;
    }

    .top-home-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      padding: 12px 20px;
      background: rgba(255, 255, 255, 0.95);
      color: #374151;
      text-decoration: none;
      border-radius: 25px;
      font-weight: 600;
      font-size: 14px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .top-home-btn:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
    }

    .top-home-btn .icon {
      width: 16px;
      height: 16px;
    }

    @media (max-width: 1024px) {
      .container {
        grid-template-columns: 1fr;
        height: auto;
      }

      .sidebar {
        order: 2;
      }
    }
  </style>
</head>
<body>
  <!-- Top right home button -->
  <a href="index.html" class="top-home-btn">
    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
      <polyline points="9,22 9,12 15,12 15,22"></polyline>
    </svg>
    Home
  </a>

  <div class="header">
    <h1>Data Manager</h1>
    <p>Add and manage city data with interactive coordinate selection</p>
  </div>

  <div class="container">
    <!-- Sidebar with forms and city list -->
    <div class="sidebar">
      <!-- Add New City Form -->
      <div class="form-section">
        <h3>Add New City</h3>
        
        <!-- Basic Info -->
        <div class="form-group">
          <label for="city-name">City Name *</label>
          <input type="text" id="city-name" placeholder="Enter city name" required>
        </div>
        
        <div class="form-group">
          <label>Coordinates *</label>
          <div class="form-group" style="margin-bottom: 10px;">
            <label for="latitude">Latitude</label>
            <input type="number" id="latitude" placeholder="Latitude" step="0.000001" required>
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label for="longitude">Longitude</label>
            <input type="number" id="longitude" placeholder="Longitude" step="0.000001" required>
          </div>
          <small style="color: #6b7280; font-size: 12px;">Click on map to auto-fill coordinates</small>
        </div>

        <!-- Financial Data -->
        <div class="form-group">
          <label for="govt-spending">Government Spending ($)</label>
          <input type="number" id="govt-spending" placeholder="Government spending on football development">
        </div>

        <div class="form-group">
          <label for="private-investment">Private Investment Scale</label>
          <input type="number" id="private-investment" placeholder="Investment from private/commercial sectors">
        </div>

        <div class="form-group">
          <label for="transfer-value">Transfer Market Value ($)</label>
          <input type="number" id="transfer-value" placeholder="Total market value of domestic transfers">
        </div>

        <!-- Participation Data -->
        <div class="form-group">
          <label for="registered-players">Registered Players</label>
          <input type="number" id="registered-players" placeholder="Number of registered football players">
        </div>

        <div class="form-group">
          <label for="youth-participation">Youth Participation Rate</label>
          <input type="number" id="youth-participation" placeholder="0.0 - 1.0" step="0.01" min="0" max="1">
        </div>

        <div class="form-group">
          <label for="football-clubs">Number of Football Clubs</label>
          <input type="number" id="football-clubs" placeholder="Total football clubs in the city">
        </div>

        <div class="form-group">
          <label for="tv-viewership">TV/Online Viewership Rate</label>
          <input type="number" id="tv-viewership" placeholder="0.0 - 1.0" step="0.01" min="0" max="1">
        </div>

        <!-- Performance & Infrastructure -->
        <div class="form-group">
          <label for="ticket-sales">Average Ticket Sales</label>
          <input type="number" id="ticket-sales" placeholder="Average ticket sales for local events">
        </div>

        <div class="form-group">
          <label for="exported-players">Exported Players</label>
          <input type="number" id="exported-players" placeholder="Players exported to other countries">
        </div>

        <div class="form-group">
          <label for="league-ranking">National League International Ranking</label>
          <input type="number" id="league-ranking" placeholder="1, 2, 3..." min="1">
        </div>

        <div class="form-group">
          <label for="coaches-referees">Coaches & Referees</label>
          <input type="number" id="coaches-referees" placeholder="Number of registered coaches and referees">
        </div>

        <div class="form-group">
          <label for="major-events">Major Events Per Year</label>
          <input type="number" id="major-events" placeholder="Frequency of major football events hosted">
        </div>

        <!-- Market & Education -->
        <div class="form-group">
          <label for="market-share">Market Share of Football Content</label>
          <input type="number" id="market-share" placeholder="0.0 - 1.0" step="0.01" min="0" max="1">
        </div>

        <div class="form-group">
          <label for="education-presence">Education System Presence</label>
          <select id="education-presence">
            <option value="">Select level</option>
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
          </select>
        </div>

        <!-- FDI Scores -->
        <div class="form-group">
          <label for="unweighted-fdi">Unweighted FDI</label>
          <input type="number" id="unweighted-fdi" placeholder="0-100" step="0.1" min="0" max="100">
        </div>

        <div class="form-group">
          <label for="weighted-fdi">Weighted FDI *</label>
          <input type="number" id="weighted-fdi" placeholder="0-100" step="0.1" min="0" max="100" required>
        </div>

        <div class="btn-group">
          <button class="btn success" id="add-city-btn" disabled>Add City</button>
          <button class="btn secondary" id="clear-form-btn">Clear Form</button>
        </div>
      </div>

      <!-- City List -->
      <div class="form-section">
        <h3>Current Cities</h3>
        <div class="city-list" id="city-list"></div>
        <div class="btn-group">
          <button class="btn danger" id="delete-city-btn" disabled>Delete Selected</button>
          <button class="btn secondary" id="edit-city-btn" disabled>Edit Selected</button>
        </div>
      </div>

      <!-- Import Section -->
      <div class="form-section">
        <h3>Import Data</h3>
        <input type="file" id="import-file" accept=".json,.xlsx,.csv" style="margin-bottom: 10px;">
        <div class="btn-group">
          <button class="btn" id="import-btn">Import File</button>
        </div>
      </div>

      <!-- Export Section -->
      <div class="export-section">
        <h4>Export Data</h4>
        <p style="margin-bottom: 10px; font-size: 13px; color: #6b7280;">
          Download the files and upload them to your GitHub repository
        </p>
        <button class="btn success" id="export-all-btn" style="background: #059669; margin-bottom: 10px; width: 100%;">Export All Files (JSON + JS + Excel)</button>
        <div class="btn-group">
          <button class="btn success" id="export-json-btn">data.json</button>
          <button class="btn success" id="export-js-btn">data-simplified.js</button>
          <button class="btn secondary" id="export-coords-btn">coordinates.json</button>
        </div>
      </div>

      <!-- Navigation -->
      <div style="text-align: center; margin-top: 20px;">
        <a href="index.html" class="btn secondary">Back to Home</a>
      </div>

      <!-- Status Messages -->
      <div id="status-container"></div>
    </div>

    <!-- Map Container -->
    <div class="map-container">
      <div class="map-instructions">
        Click on the map to select coordinates for the new city
      </div>
      <div id="map"></div>
    </div>
  </div>

  <script>
    // Global variables
    let map;
    let currentMarker = null;
    let selectedCoordinates = null;
    let cityData = [];
    let selectedCityIndex = -1;

    // Initialize map
    function initMap() {
      map = L.map('map').setView([40.7128, -74.0060], 2);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      // Add click event to map
      map.on('click', function(e) {
        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);
        
        // Update coordinate inputs
        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lng;
        
        selectedCoordinates = [lat, lng];
        
        // Remove existing marker
        if (currentMarker) {
          map.removeLayer(currentMarker);
        }
        
        // Add new marker
        currentMarker = L.marker([lat, lng]).addTo(map);
        
        // Enable add button if city name is filled
        checkFormValidation();
        
        showStatus(`Coordinates selected: ${lat}, ${lng}`, 'info');
      });
    }

    // Check form validation
    function checkFormValidation() {
      const cityName = document.getElementById('city-name').value.trim();
      const weightedFDI = document.getElementById('weighted-fdi').value;
      const addButton = document.getElementById('add-city-btn');
      
      if (cityName && selectedCoordinates && weightedFDI) {
        addButton.disabled = false;
      } else {
        addButton.disabled = true;
      }
    }

    // Add city function
    function addCity() {
      const cityName = document.getElementById('city-name').value.trim();
      const weightedFDI = parseFloat(document.getElementById('weighted-fdi').value);
      
      if (!cityName || !selectedCoordinates || isNaN(weightedFDI)) {
        showStatus('Please fill in required fields: City Name, Coordinates, and Weighted FDI', 'error');
        return;
      }

      // Collect all form data
      const newCity = {
        name: cityName,
        lat: parseFloat(selectedCoordinates[0]),
        lng: parseFloat(selectedCoordinates[1]),
        'Government spending on football-related development ($)': parseFloat(document.getElementById('govt-spending').value) || null,
        'Investment scale from private or commercial sectors': parseFloat(document.getElementById('private-investment').value) || null,
        'Registered football players': parseFloat(document.getElementById('registered-players').value) || null,
        'Youth football participation rate': parseFloat(document.getElementById('youth-participation').value) || null,
        'Number of football clubs in the city': parseFloat(document.getElementById('football-clubs').value) || null,
        'Percentage of the population watching football games regularly on TV/online': parseFloat(document.getElementById('tv-viewership').value) || null,
        'Average ticket sales for local football events': parseFloat(document.getElementById('ticket-sales').value) || null,
        'Number of professional football players exported to other countries\' leagues': parseFloat(document.getElementById('exported-players').value) || null,
        'National top-tier football league international ranking': parseFloat(document.getElementById('league-ranking').value) || null,
        'Number of registered football coaches and referees': parseFloat(document.getElementById('coaches-referees').value) || null,
        'Total market value of domestic football transfers': parseFloat(document.getElementById('transfer-value').value) || null,
        'Frequency of major football events hosted annually': parseFloat(document.getElementById('major-events').value) || null,
        'Market Share of Football Content': parseFloat(document.getElementById('market-share').value) || null,
        'Presence of Football Leagues in the Education System': document.getElementById('education-presence').value || null,
        'Unweighted FDI': parseFloat(document.getElementById('unweighted-fdi').value) || null,
        'weighted FDI': weightedFDI
      };

      cityData.push(newCity);
      updateCityList();
      reloadMapMarkers();
      clearForm();
      showStatus(`Added city: ${cityName}`, 'success');
    }

    // Clear form
    function clearForm() {
      document.getElementById('city-name').value = '';
      document.getElementById('latitude').value = '';
      document.getElementById('longitude').value = '';
      document.getElementById('govt-spending').value = '';
      document.getElementById('private-investment').value = '';
      document.getElementById('registered-players').value = '';
      document.getElementById('youth-participation').value = '';
      document.getElementById('football-clubs').value = '';
      document.getElementById('tv-viewership').value = '';
      document.getElementById('ticket-sales').value = '';
      document.getElementById('exported-players').value = '';
      document.getElementById('league-ranking').value = '';
      document.getElementById('coaches-referees').value = '';
      document.getElementById('transfer-value').value = '';
      document.getElementById('major-events').value = '';
      document.getElementById('market-share').value = '';
      document.getElementById('education-presence').value = '';
      document.getElementById('unweighted-fdi').value = '';
      document.getElementById('weighted-fdi').value = '';
      
      selectedCoordinates = null;
      
      if (currentMarker) {
        map.removeLayer(currentMarker);
        currentMarker = null;
      }
      
      checkFormValidation();
    }

    // Update city list display
    function updateCityList() {
      const cityList = document.getElementById('city-list');
      cityList.innerHTML = '';
      
      cityData.forEach((city, index) => {
        const cityItem = document.createElement('div');
        cityItem.className = 'city-item';
        cityItem.innerHTML = `
          <div class="city-name">${city.name}</div>
          <div class="city-coords">FDI: ${city['weighted FDI']} | ${city.lat.toFixed(4)}, ${city.lng.toFixed(4)}</div>
        `;
        
        cityItem.addEventListener('click', () => selectCity(index));
        cityList.appendChild(cityItem);
      });
    }

    // Select city
    function selectCity(index) {
      selectedCityIndex = index;
      
      // Update UI
      const cityItems = document.querySelectorAll('.city-item');
      cityItems.forEach((item, i) => {
        item.classList.toggle('selected', i === index);
      });
      
      // Enable action buttons
      document.getElementById('delete-city-btn').disabled = false;
      document.getElementById('edit-city-btn').disabled = false;
      
      // Center map on selected city
      const city = cityData[index];
      map.setView([city.lat, city.lng], 10);
    }

    // Delete selected city
    function deleteCity() {
      if (selectedCityIndex >= 0) {
        const cityName = cityData[selectedCityIndex].name;
        cityData.splice(selectedCityIndex, 1);
        selectedCityIndex = -1;
        
        updateCityList();
        reloadMapMarkers();
        
        document.getElementById('delete-city-btn').disabled = true;
        document.getElementById('edit-city-btn').disabled = true;
        
        showStatus(`Deleted city: ${cityName}`, 'success');
      }
    }

    // Reload map markers
    function reloadMapMarkers() {
      // Clear existing markers except current selection marker
      map.eachLayer(function(layer) {
        if (layer instanceof L.Marker && layer !== currentMarker) {
          map.removeLayer(layer);
        }
      });
      
      // Add markers for all cities
      cityData.forEach(city => {
        const marker = L.marker([city.lat, city.lng])
          .addTo(map)
          .bindPopup(`<strong>${city.name}</strong><br>FDI: ${city['weighted FDI']}`);
      });
    }

    // Export functions
    function exportDataJson() {
      if (cityData.length === 0) {
        showStatus('No data to export', 'error');
        return;
      }

      // Create header row matching Excel format
      const headers = [
        'City Name', 'Government spending on football-related development ($)',
        'Investment scale from private or commercial sectors', 'Registered football players',
        'Youth football participation rate', 'Number of football clubs in the city',
        'Percentage of the population watching football games regularly on TV/online',
        'Average ticket sales for local football events',
        'Number of professional football players exported to other countries\' leagues',
        'National top-tier football league international ranking',
        'Number of registered football coaches and referees',
        'Total market value of domestic football transfers',
        'Frequency of major football events hosted annually',
        'Market Share of Football Content',
        'Presence of Football Leagues in the Education System',
        'Unweighted FDI', 'weighted FDI', 'Latitude', 'Longitude'
      ];
      
      const data = [headers];
      
      // Add data rows
      cityData.forEach(city => {
        const row = [
          city.name,
          city['Government spending on football-related development ($)'],
          city['Investment scale from private or commercial sectors'],
          city['Registered football players'],
          city['Youth football participation rate'],
          city['Number of football clubs in the city'],
          city['Percentage of the population watching football games regularly on TV/online'],
          city['Average ticket sales for local football events'],
          city['Number of professional football players exported to other countries\' leagues'],
          city['National top-tier football league international ranking'],
          city['Number of registered football coaches and referees'],
          city['Total market value of domestic football transfers'],
          city['Frequency of major football events hosted annually'],
          city['Market Share of Football Content'],
          city['Presence of Football Leagues in the Education System'],
          city['Unweighted FDI'],
          city['weighted FDI'],
          city.lat,
          city.lng
        ];
        data.push(row);
      });

      downloadFile(JSON.stringify(data, null, 2), 'data.json', 'application/json');
      showStatus('data.json exported successfully!', 'success');
    }

    function exportDataJs() {
      if (cityData.length === 0) {
        showStatus('No data to export', 'error');
        return;
      }

      // Create data in same format as JSON export
      const headers = [
        'City Name', 'Government spending on football-related development ($)',
        'Investment scale from private or commercial sectors', 'Registered football players',
        'Youth football participation rate', 'Number of football clubs in the city',
        'Percentage of the population watching football games regularly on TV/online',
        'Average ticket sales for local football events',
        'Number of professional football players exported to other countries\' leagues',
        'National top-tier football league international ranking',
        'Number of registered football coaches and referees',
        'Total market value of domestic football transfers',
        'Frequency of major football events hosted annually',
        'Market Share of Football Content',
        'Presence of Football Leagues in the Education System',
        'Unweighted FDI', 'weighted FDI', 'Latitude', 'Longitude'
      ];
      
      const data = [headers];
      
      cityData.forEach(city => {
        const row = [
          city.name,
          city['Government spending on football-related development ($)'],
          city['Investment scale from private or commercial sectors'],
          city['Registered football players'],
          city['Youth football participation rate'],
          city['Number of football clubs in the city'],
          city['Percentage of the population watching football games regularly on TV/online'],
          city['Average ticket sales for local football events'],
          city['Number of professional football players exported to other countries\' leagues'],
          city['National top-tier football league international ranking'],
          city['Number of registered football coaches and referees'],
          city['Total market value of domestic football transfers'],
          city['Frequency of major football events hosted annually'],
          city['Market Share of Football Content'],
          city['Presence of Football Leagues in the Education System'],
          city['Unweighted FDI'],
          city['weighted FDI'],
          city.lat,
          city.lng
        ];
        data.push(row);
      });

      const jsContent = `// Complete inline data with coordinates - automatically generated
window.INLINE_DATA = ${JSON.stringify(data, null, 2)};

// Function to use inline data (keep this function)
function loadInlineData() {
  if (window.INLINE_DATA && window.INLINE_DATA.length > 0) {
    console.log('Loading inline data...');
    window.excelParser.parseData(window.INLINE_DATA);
    const cities = window.excelParser.getCities();
    
    if (cities.length > 0) {
      loadCitiesData(cities);
      console.log('Cities loaded from inline data:', cities.length, 'cities found');
      return true;
    }
  }
  return false;
}`;

      downloadFile(jsContent, 'data-simplified.js', 'application/javascript');
      showStatus('data-simplified.js exported successfully!', 'success');
    }

    function exportCoordinatesJson() {
      const coordinates = {};
      cityData.forEach(city => {
        coordinates[city.name.toLowerCase()] = [city.lat, city.lng];
      });

      downloadFile(JSON.stringify(coordinates, null, 2), 'coordinates.json', 'application/json');
      showStatus('coordinates.json exported successfully!', 'success');
    }

    // Export all files with one click
    function exportAllFiles() {
      if (cityData.length === 0) {
        showStatus('No data to export', 'error');
        return;
      }

      // Prepare data in consistent format
      const headers = [
        'City Name', 'Government spending on football-related development ($)',
        'Investment scale from private or commercial sectors', 'Registered football players',
        'Youth football participation rate', 'Number of football clubs in the city',
        'Percentage of the population watching football games regularly on TV/online',
        'Average ticket sales for local football events',
        'Number of professional football players exported to other countries\' leagues',
        'National top-tier football league international ranking',
        'Number of registered football coaches and referees',
        'Total market value of domestic football transfers',
        'Frequency of major football events hosted annually',
        'Market Share of Football Content',
        'Presence of Football Leagues in the Education System',
        'Unweighted FDI', 'weighted FDI', 'Latitude', 'Longitude'
      ];
      
      const data = [headers];
      
      cityData.forEach(city => {
        const row = [
          city.name,
          city['Government spending on football-related development ($)'],
          city['Investment scale from private or commercial sectors'],
          city['Registered football players'],
          city['Youth football participation rate'],
          city['Number of football clubs in the city'],
          city['Percentage of the population watching football games regularly on TV/online'],
          city['Average ticket sales for local football events'],
          city['Number of professional football players exported to other countries\' leagues'],
          city['National top-tier football league international ranking'],
          city['Number of registered football coaches and referees'],
          city['Total market value of domestic football transfers'],
          city['Frequency of major football events hosted annually'],
          city['Market Share of Football Content'],
          city['Presence of Football Leagues in the Education System'],
          city['Unweighted FDI'],
          city['weighted FDI'],
          city.lat,
          city.lng
        ];
        data.push(row);
      });

      // 1. Export data.json
      downloadFile(JSON.stringify(data, null, 2), 'data.json', 'application/json');
      
      // 2. Export data-simplified.js
      const jsContent = `// Complete inline data with coordinates - automatically generated
window.INLINE_DATA = ${JSON.stringify(data, null, 2)};

// Function to use inline data (keep this function)
function loadInlineData() {
  if (window.INLINE_DATA && window.INLINE_DATA.length > 0) {
    console.log('Loading inline data...');
    window.excelParser.parseData(window.INLINE_DATA);
    const cities = window.excelParser.getCities();
    
    if (cities.length > 0) {
      loadCitiesData(cities);
      console.log('Cities loaded from inline data:', cities.length, 'cities found');
      return true;
    }
  }
  return false;
}`;
      
      setTimeout(() => downloadFile(jsContent, 'data-simplified.js', 'application/javascript'), 200);
      
      // 3. Export data.xlsx (real Excel file)
      const worksheet = XLSX.utils.aoa_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Cities');
      
      const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
      const excelBlob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      
      setTimeout(() => {
        const url = URL.createObjectURL(excelBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'data.xlsx';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 400);

      showStatus(`All files exported successfully! (${cityData.length} cities)`, 'success');
      showStatus('Files downloaded: data.json, data-simplified.js, data.xlsx', 'info');
    }

    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function showStatus(message, type = 'info') {
      const statusContainer = document.getElementById('status-container');
      const statusDiv = document.createElement('div');
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
      
      statusContainer.appendChild(statusDiv);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (statusDiv.parentNode) {
          statusDiv.parentNode.removeChild(statusDiv);
        }
      }, 5000);
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      initMap();
      loadExistingData(); // 加载现有数据
      
      // Form validation events
      document.getElementById('city-name').addEventListener('input', checkFormValidation);
      document.getElementById('weighted-fdi').addEventListener('input', checkFormValidation);
      
      // Button events
      document.getElementById('add-city-btn').addEventListener('click', addCity);
      document.getElementById('clear-form-btn').addEventListener('click', clearForm);
      document.getElementById('delete-city-btn').addEventListener('click', deleteCity);
      
      // Export events
      document.getElementById('export-all-btn').addEventListener('click', exportAllFiles);
      document.getElementById('export-json-btn').addEventListener('click', exportDataJson);
      document.getElementById('export-js-btn').addEventListener('click', exportDataJs);
      document.getElementById('export-coords-btn').addEventListener('click', exportCoordinatesJson);
    });

    // Load existing data from data-simplified.js or data.json
    async function loadExistingData() {
      try {
        showStatus('Loading existing data...', 'info');
        
        // Method 1: Try to load from data-simplified.js (inline data)
        try {
          const response = await fetch('data-simplified.js');
          if (response.ok) {
            const jsContent = await response.text();
            
            // Extract INLINE_DATA from the JS file
            const match = jsContent.match(/window\.INLINE_DATA\s*=\s*(\[[\s\S]*?\]);/);
            if (match) {
              const data = JSON.parse(match[1]);
              loadDataFromArray(data);
              return;
            }
          }
        } catch (error) {
          console.log('Could not load from data-simplified.js, trying data.json');
        }
        
        // Method 2: Try to load from data.json
        try {
          const response = await fetch('data.json');
          if (response.ok) {
            const data = await response.json();
            loadDataFromArray(data);
            return;
          }
        } catch (error) {
          console.log('Could not load from data.json');
        }
        
        // Method 3: Check if window.INLINE_DATA is already available
        if (window.INLINE_DATA && window.INLINE_DATA.length > 0) {
          loadDataFromArray(window.INLINE_DATA);
          return;
        }
        
        showStatus('No existing data found, starting fresh', 'info');
        
      } catch (error) {
        console.error('Error loading existing data:', error);
        showStatus('Could not load existing data, starting fresh', 'info');
      }
    }
    
    // Helper function to parse data array
    function loadDataFromArray(data) {
      if (!data || data.length <= 1) {
        showStatus('No data to load', 'info');
        return;
      }
      
      const headers = data[0];
      
      // Find required column indices
      const cityNameIndex = headers.findIndex(h => h === 'City Name' || h.toLowerCase().includes('city'));
      const latIndex = headers.findIndex(h => h === 'Latitude' || h.toLowerCase().includes('lat'));
      const lngIndex = headers.findIndex(h => h === 'Longitude' || h.toLowerCase().includes('lng'));
      const weightedFDIIndex = headers.findIndex(h => h === 'weighted FDI' || h.toLowerCase().includes('weighted'));
      
      // Parse existing cities
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        
        // Skip invalid rows
        if (!row || row.length < 3) continue;
        
        let cityName, lat, lng, weightedFDI;
        
        if (cityNameIndex >= 0 && latIndex >= 0 && lngIndex >= 0) {
          // Data has proper headers
          cityName = row[cityNameIndex];
          lat = parseFloat(row[latIndex]);
          lng = parseFloat(row[lngIndex]);
          weightedFDI = weightedFDIIndex >= 0 ? parseFloat(row[weightedFDIIndex]) : null;
        } else {
          // Assume first item is city name, try to find coordinates
          cityName = row[0];
          
          // Try to find lat/lng in the row
          for (let j = 1; j < row.length; j++) {
            const val = parseFloat(row[j]);
            if (!isNaN(val) && val >= -90 && val <= 90 && !lat) {
              lat = val;
            } else if (!isNaN(val) && val >= -180 && val <= 180 && lat && !lng) {
              lng = val;
              break;
            }
          }
          
          // Try to find weighted FDI (usually a score 0-100)
          for (let j = 1; j < row.length; j++) {
            const val = parseFloat(row[j]);
            if (!isNaN(val) && val >= 0 && val <= 100 && val !== lat && val !== lng) {
              weightedFDI = val;
              break;
            }
          }
        }
        
        if (cityName && !isNaN(lat) && !isNaN(lng)) {
          const city = {
            name: cityName,
            lat: lat,
            lng: lng,
            'weighted FDI': weightedFDI || 0
          };
          
          // Add all other data fields
          headers.forEach((header, index) => {
            if (header !== 'City Name' && header !== 'Latitude' && header !== 'Longitude' && header !== 'weighted FDI') {
              city[header] = row[index] || null;
            }
          });
          
          cityData.push(city);
        }
      }
      
      updateCityList();
      reloadMapMarkers();
      showStatus(`Loaded ${cityData.length} existing cities`, 'success');
    }
  </script>
</body>
</html>
